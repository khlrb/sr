#include "aud.h"

uint8_t SOL3[] = { 0, 1, 2, 3, 6, 0xA, 0xF, 0x15 };

uint16_t SOL7[] = {
   0x0,   0x8,    0x10,   0x20,   0x30,   0x40,   0x50,   0x60,
   0x70,  0x80,   0x90,   0xA0,   0xB0,   0xC0,   0xD0,   0xE0,
   0xF0,  0x100,  0x110,  0x120,  0x130,  0x140,  0x150,  0x160,
   0x170, 0x180,  0x190,  0x1A0,  0x1B0,  0x1C0,  0x1D0,  0x1E0,
   0x1F0, 0x200,  0x208,  0x210,  0x218,  0x220,  0x228,  0x230,
   0x238, 0x240,  0x248,  0x250,  0x258,  0x260,  0x268,  0x270,
   0x278, 0x280,  0x288,  0x290,  0x298,  0x2A0,  0x2A8,  0x2B0,
   0x2B8, 0x2C0,  0x2C8,  0x2D0,  0x2D8,  0x2E0,  0x2E8,  0x2F0,
   0x2F8, 0x300,  0x308,  0x310,  0x318,  0x320,  0x328,  0x330,
   0x338, 0x340,  0x348,  0x350,  0x358,  0x360,  0x368,  0x370,
   0x378, 0x380,  0x388,  0x390,  0x398,  0x3A0,  0x3A8,  0x3B0,
   0x3B8, 0x3C0,  0x3C8,  0x3D0,  0x3D8,  0x3E0,  0x3E8,  0x3F0,
   0x3F8, 0x400,  0x440,  0x480,  0x4C0,  0x500,  0x540,  0x580,
   0x5C0, 0x600,  0x640,  0x680,  0x6C0,  0x700,  0x740,  0x780,
   0x7C0, 0x800,  0x900,  0xA00,  0xB00,  0xC00,  0xD00,  0xE00,
   0xF00, 0x1000, 0x1400, 0x1800, 0x1C00, 0x2000, 0x3000, 0x4000
};


int read_aud_header(FILE* in, AudHeader* header) {
  int r = 0;
  uint8_t* mab   = malloc(4);
  uint8_t sol[] = { 's', 'o', 'l', '\0' };

  fread(&header->version, sizeof(uint8_t), 1, in);
  fread(&header->header_size, sizeof(uint8_t), 1, in);
  fread(mab, sizeof(uint8_t), 4, in);
  fread(&header->sample_rate, sizeof(uint16_t), 1, in);
  fread(&header->flags, sizeof(uint8_t), 1, in);
  fread(&header->size, sizeof(uint16_t), 1, in);

  if (memcpy(mab,sol,4) != 0) {
    r = -1;
  }

  free(mab);

  return r;
}

int read_aud(FILE* in, FILE* out, AudHeader* header) {
  return 0;
}

int read_8bit_adpcm(FILE* in, FILE* out, AudHeader* header) {
  uint8_t current = 0x80;
  uint8_t buff = 0;
  uint8_t t = 0;

  for(uint16_t i = 0; i < header->size; ++i) {
    fread(&buff, sizeof(uint8_t), 1, in);

    t = buff >> 4;

    if (t & 8)
      current -= SOL3[0xf-t];
    else
      current += SOL3[t];

    fwrite(&current, sizeof(uint8_t), 1, out);

    t = buff & 0x0f;

    if (t & 8)
      current -= SOL3[0xf-t];
    else
      current += SOL3[t];

    fwrite(&current, sizeof(uint8_t), 1, out);
  }

  return 0;
}

int read_16bit_adpcm(FILE* in, FILE* out, AudHeader* header) {
  uint16_t current = 0x0000;
  uint8_t buff = 0;

  for(uint16_t i = 0; i < header->size; ++i) {
    fread(&buff, sizeof(uint8_t), 1, in);

    if (buff & 0x80)
      current -= SOL7[buff & 0x7f];
    else
      current += SOL7[buff];

    fwrite(&current, sizeof(uint8_t), 1, out);
  }

  return 0;
}


